<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>McbeEringi avr_musicbox gui</title>
	<meta name="description" content="gui for avr_musicbox">
	<link rel="icon" type="image/svg+xml" href="https://mcbeeringi.github.io/img/icon.svg">
	<link rel="apple-touch-icon" href="https://mcbeeringi.github.io/img/icon.png">
	<meta name="theme-color" content="#214"/>

	<link rel="stylesheet" href="https://mcbeeringi.github.io/src/style.css">
	<link rel="stylesheet" href="https://mcbeeringi.github.io/src/comp.css">
</head>
<body>
<style>:root{image-rendering:pixelated;}</style>
<canvas id="c"></canvas>
<script>
	const
	dark=matchMedia('(prefers-color-scheme:dark)'),
	ctx=c.getContext('2d'),
	actx=new(window.AudioContext||webkitAudioContext)(),
	fft=w=>((
		n=[...Array(Math.log2(w.length))],br=x=>n.reduce((a,_,i)=>(a<<1)|(x>>>i&1),0),trs=x=>x[0].map((_,i)=>x.map(y=>y[i])),
		pm=(a,b,[c,d])=>[[a+c,b+d],[a-c,b-d]],mul=(a,b,c,d)=>[a*c-b*d,a*d+b*c],core=([a,b],[c,d],t)=>pm(a,b,mul(c,d,Math.cos(t*=-Math.PI),Math.sin(t)))
	)=>trs(n.reduce((a,x,i)=>(x=2**i,[...Array(a.length/2)].forEach((_,j)=>[a[i+j],a[i+j+x]]=core(a[(i=(j/x|0)*x*2)+(j%=x)],a[i+j+x],j/x)),a),w.map((_,i)=>[w[br(i)],0]))))(),
	pwav=[[1,1,0,0],[1,0,0,0]].map(w=>actx.createPeriodicWave(...fft(w.flatMap(x=>Array(4096/w.length).fill(x*2-1))).map(x=>new Float32Array([0,...x.slice(1)])))),
	w={
		bin:location.hash?[...atob(location.hash.slice(1))].map(x=>x.charCodeAt()):[],
		get a(){return this._a||(this._a=this.bin.reduce((a,x,i)=>(
			1<i&&!a.done&&([
				_=>a.a.notes.length&&!a.a.notes[a.a.notes.length-1].length?(a.a.notes.pop(),a.done=!0):(a.a.notes.push([]),a.t=0,a.dt=[]),
				_=>a.fin=a.t,,,,,_=>a.cfg=x&0x1f,_=>a.dt[x>>5&1]=(x&0x1f)+1,
				_=>(
					11<(x&15)||a.a.notes[a.a.notes.length-1].push({n:((a.cfg>>3&1?1:4)+(x>>4&3)+1)*12+(x&15),t:a.t,dt:a.dt[x>>6&1],half:!!(a.cfg&4),mod:!!(a.cfg&2),env:!!(a.cfg&1)}),
					a.t+=a.dt[x>>6&1]
				)
			][Math.log2(x)+!!x|0]||(_=>console.log(`unknown command 0x${x.toString(16).padStart(2,0)}@0x${i.toString(16)}`)))(),
			a
		),{a:{tpm:this.bin[0]<<3|this.bin[1]>>5,loop:this.bin[1]&1,notes:[]},_(){this.a.spt=60/this.a.tpm;this.a.notes=this.a.notes.map(x=>x.filter(x=>x.t<this.fin));return this.a;}})._());},
		set a(x){this._a=null;this.bin=x;}
	},
	patt=((c=document.createElement('canvas'),ctx=c.getContext('2d'))=>(
		c.width=4*2,c.height=4*12,
		ctx.fillStyle='#fff',ctx.fillRect(0,0,c.width,c.height)
		[1,0,1,0,1,1,0,1,0,1,0,1].forEach(x=>(
			ctx.fillStyle=x?'#fff':'#000'
		))
	))(),
	render=_=>(
		ctx.lineWidth=1,
		ctx.clearRect(0,0,c.width,c.height),
		ctx.fillStyle=patt,ctx.fillRect(0,0,c.width,c.height),
		w.a.notes.forEach((x,i)=>(ctx.strokeStyle=ctx.fillStyle=`#${['f48','f84','8f4','48f'][i]||'f0f'}c`,x.forEach(x=>(
			x=[x.t*4,c.height-(x.n-24)*4,x.dt*4,4],
			ctx.fillRect(...x),ctx.strokeRect(...x.map((x,i)=>x+(i<2?ctx.lineWidth/2:-ctx.lineWidth)))
		))))
	),
	play=(t=0,t0=actx.currentTime+.05)=>(a=>_=>(a.forEach(x=>x&&x()),(actx.currentTime-t0)/w.a.spt+t))(
		w.a.notes.flat().map(x=>!(x.t<t)&&((osc=actx.createOscillator(),g=actx.createGain())=>(
			osc.setPeriodicWave(pwav[+x.mod]),
			osc.frequency.value=440*2**((x.n-69)/12),
			g.gain.value=[1,.5][+x.half]*.2,
			x.env||g.gain.setTargetAtTime(0,t0+(x.t-t)*w.a.spt,.2),
			[osc,g,actx.destination].reduce((a,x)=>(a.connect(x),x)),
			osc.start(t0+(x.t-t)*w.a.spt),osc.stop(t0+(x.t-t+x.dt)*w.a.spt),
			_=>osc.stop()
		))())
	);

	c.onclick=_=>play();

	let resizet;
	(onresize=(e,bcr=c.getBoundingClientRect())=>(
		c.height=4*84,c.width=4500,
		c.style.height=c.height*2+'px',c.style.width=c.width*.3+'px',
		render()
	))();
	dark.addEventListener?dark.addEventListener('change',render):dark.addListener(render);
	['touchstart','mousedown'].forEach(x=>addEventListener(x,_=>(actx.state=='suspended'&&actx.resume())));

</script>
</body>
</html>
