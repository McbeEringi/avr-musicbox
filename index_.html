<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>McbeEringi t202_musicbox mml</title>
	<meta name="description" content="mml for t85_musicbox">
	<link rel="icon" type="image/svg+xml" href="https://mcbeeringi.github.io/img/icon.svg">
	<link rel="apple-touch-icon" href="https://mcbeeringi.github.io/img/icon.png">
	<meta name="theme-color" content="#214"/>

	<link rel="stylesheet" href="https://mcbeeringi.github.io/src/style.css">
</head>
<body>
	<style>
		#ta{width:100%;font-family:monospace;tab-size:2;}*{max-width:100%;}
	</style>
	<textarea id="ta" class="zab" spellcheck="false">{
	header:{
		tps:(({bpm:a,min_note:b})=>a*b/240)({bpm:120,min_note:16}),
		loop:false,
	},
	tracks:[
		{
			wave:[3,3,0,0],
			envelope:true,
			tick_div:Math.log2(1)|0,
			octave:0,
			notes:[
				[4,3],[4,5],[4,7]
			]
		}
	]
}</textarea>
	<button id="pbtn" class="zab bgca">play</button><br>
	<canvas id="c" width="1024" height="512"></canvas>
	<pre id="log"></pre>
	
	<script type="module">
		import TA from'https://mcbeeringi.github.io/ta/ta+.mjs';
		location.hash&&(ta.value=decodeURIComponent(location.hash.slice(1)));
		TA.editor(ta);

		const
		actx=new(window.AudioContext||webkitAudioContext)(),
		aly=Object.assign(actx.createAnalyser(),{fftSize:256}),
		wfa=new Uint8Array(aly.fftSize),
		ctx=c.getContext('2d'),
		fft=w=>((
			n=[...Array(Math.log2(w.length))],br=x=>n.reduce((a,_,i)=>(a<<1)|(x>>>i&1),0),trs=x=>x[0].map((_,i)=>x.map(y=>y[i])),
			pm=(a,b,[c,d])=>[[a+c,b+d],[a-c,b-d]],mul=(a,b,c,d)=>[a*c-b*d,a*d+b*c],core=([a,b],[c,d],t)=>pm(a,b,mul(c,d,Math.cos(t*=-Math.PI),Math.sin(t)))
		)=>trs(n.reduce((a,x,i)=>(x=2**i,[...Array(a.length/2)].forEach((_,j)=>[a[i+j],a[i+j+x]]=core(a[(i=(j/x|0)*x*2)+(j%=x)],a[i+j+x],j/x)),a),w.map((_,i)=>[w[br(i)],0]))))(),
		pwav=w=>actx.createPeriodicWave(...fft(w.flatMap(x=>Array(4096/w.length).fill(x*2-1))).map(x=>new Float32Array([0,...x.slice(1)]))),
		draw=_=>(
			aly.getByteTimeDomainData(wfa),
			ctx.strokeStyle='#fff',ctx.lineWidth=2,
			ctx.clearRect(0,0,c.width,c.height),
			ctx.beginPath(),
			[...Array(c.width)].forEach((_,i,{length:l})=>ctx.lineTo(i,wfa[Math.round(wfa.length*i/l)]/255*c.height)),
			ctx.stroke(),
			requestAnimationFrame(draw)
		);self.wfa=wfa;

		pbtn.onclick=s=>(
			location.hash=encodeURIComponent(ta.value),
			s=Function('return '+ta.value)(),
			console.log(s),
			s.tracks.forEach(w=>(
				w.pwav=pwav(w.wave.map(x=>x/3)),
				w.notes.reduce((a,x)=>(
					isNaN(x[1])||((osc=actx.createOscillator(),g=actx.createGain())=>(
						osc.frequency.value=440*2**(x[1]/12+w.octave),
						osc.setPeriodicWave(w.pwav),
						g.gain.setValueAtTime(Math.max(...w.wave)/3*.2,0),
						w.envelope&&(g.gain.setTargetAtTime(.01,a.rt(),.3)),
						[osc,g,aly,actx.destination].reduce((a,x)=>(a.connect(x),x)),
						osc.start(a.rt()),osc.stop(a.rt(a.t+x[0]))
					))(),
					a.t+=x[0],
					a
				),{t:0,rt0:actx.currentTime,rt(t=this.t){return this.rt0+t*2**w.tick_div/(s.header.bpm/s.header.min_note)*240;}})
			)),
			s.la=[255,...new Set(Function('return'+ta.value)().tracks.flatMap(x=>x.notes.map(y=>y[0])).sort((a,b)=>a-b))],
			s.l=s.la.reduce((a,x,i)=>(a[x]=i,a),{}),

			log.textContent=`${s.header.bpm/s.header.min_note>>5},${((s.header.bpm/s.header.min_note<<3)&0b11111)|!!s.header.loop<<2},
${s.la},\n`+s.tracks.map(x=>[
	0,
	x.wave[0]<<6|x.wave[1]<<4|x.wave[2]<<2|x.wave[3],
	x.wave[4]<<6|x.wave[5]<<4|x.wave[6]<<2|x.wave[7],
	(x.tick_div&3)<<6|((x.octave+2)&3)<<4|!!x.envelope<<3|!!x.noise<<2,
	...x.notes.map(x=>(s.l[x[0]]<<5|(isNaN(x[1])?0:x[1]+16)))
].join(',')).join(',\n')+',\n0,0'
		);
		draw();
	</script>
</body>
</html>
